# Архитектура системы vLadoshkah

## Общая архитектура

Система построена по принципу **клиент-серверной архитектуры** с разделением на фронтенд и бэкенд.

```
┌─────────────────┐
│   React Frontend │  (Vite, Tailwind CSS)
│   Port: 5173    │
└────────┬─────────┘
         │ HTTP/REST API
         │ JWT Authentication
         ▼
┌─────────────────┐
│  Express Backend │  (Node.js, Express)
│   Port: 4000    │
└────────┬─────────┘
         │
    ┌────┴────┬──────────┬──────────┬──────────┐
    │         │          │          │          │
    ▼         ▼          ▼          ▼          ▼
┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐ ┌────────┐
│PostgreSQL│ │ Redis │ │ MinIO │ │ Kafka │ │ SMTP │
│  :5432   │ │ :6379 │ │ :9000 │ │ :9092 │ │ :587 │
└──────┘ └────────┘ └──────┘ └────────┘ └────────┘
```

## Слои бэкенда

### 1. Слой маршрутизации (Routes)
- Определяет эндпоинты API
- Применяет middleware (аутентификация, валидация, rate limiting)
- Направляет запросы в контроллеры

### 2. Слой контроллеров (Controllers)
- Обрабатывает HTTP запросы/ответы
- Извлекает данные из запросов
- Вызывает сервисы для бизнес-логики
- Формирует ответы клиенту

### 3. Слой сервисов (Services)
- Содержит бизнес-логику приложения
- Работает с DAO для доступа к данным
- Интегрируется с внешними сервисами (MinIO, Kafka, SMTP)
- Управляет кэшированием через Redis

### 4. Слой доступа к данным (DAO)
- Абстракция над базой данных
- Выполняет SQL запросы
- Возвращает нормализованные данные

### 5. Слой валидации (Validators)
- Валидация входных данных через Joi
- Проверка типов, форматов, ограничений

### 6. Middleware
- **auth.js** - JWT аутентификация и авторизация
- **validation.js** - валидация запросов
- **rateLimit.js** - ограничение частоты запросов
- **upload.js** - обработка загрузки файлов (multer)

## Интеграции

### PostgreSQL
- Основная база данных
- Хранение пользователей, животных, приютов, заявок, фотографий
- Миграции через node-pg-migrate

### Redis
- Кэширование часто запрашиваемых данных
- Rate limiting
- Хранение временных данных

### MinIO
- Объектное хранилище для фотографий
- S3-совместимый API
- Публичный доступ к файлам

### Kafka
- Асинхронная обработка событий
- Отправка уведомлений
- Топик: `user-notifications`

### SMTP (опционально)
- Email уведомления
- Приветственные письма при регистрации

## Слои фронтенда

### 1. Компоненты (Components)
- Переиспользуемые UI компоненты
- Карточки животных, приютов
- Формы, модальные окна

### 2. Страницы (Pages)
- Основные экраны приложения
- Роутинг через React Router

### 3. Сервисы (Services)
- API клиенты для взаимодействия с бэкендом
- Централизованная обработка запросов

### 4. Контекст (Context)
- Управление состоянием аутентификации
- Глобальное состояние приложения

### 5. Утилиты (Utils)
- Вспомогательные функции
- Обработка фотографий
- Утилиты для ролей

## Потоки данных

### Создание животного
```
Frontend → API → Controller → Service → DAO → PostgreSQL
                              ↓
                         PhotosService → MinIO
                              ↓
                         Kafka Producer → Notification
```

### Поиск животных
```
Frontend → API → Controller → Service → Redis (кэш)
                              ↓ (miss)
                         DAO → PostgreSQL
                              ↓
                         Redis (сохранение)
```

### Загрузка фотографии
```
Frontend (FormData) → API → Multer → Service → MinIO
                                           ↓
                                      PostgreSQL (метаданные)
```

## Безопасность

- **JWT токены**: access (7 дней) и refresh (30 дней)
- **Rate limiting**: защита от DDoS и брутфорса
- **Валидация**: проверка всех входных данных
- **Авторизация**: проверка прав доступа по ролям
- **CORS**: настройка для безопасного взаимодействия

## Масштабируемость

- **Горизонтальное масштабирование**: Docker контейнеры
- **Кэширование**: Redis для снижения нагрузки на БД
- **Асинхронная обработка**: Kafka для фоновых задач
- **Оптимизация БД**: индексы, пул соединений

