# Требования к системе vLadoshkah

## 1. Функциональные требования

### 1.1 Аутентификация и авторизация

#### FR-1.1 Регистрация пользователя
- Система должна предоставлять возможность регистрации с обязательными полями:
  - Email (валидный формат, максимум 100 символов)
  - Пароль (минимум 6 символов, максимум 255 символов)
  - Роль (user/shelter_admin/admin, по умолчанию user)
- Email должен быть уникальным в системе
- Пароль должен хешироваться перед сохранением
- После регистрации пользователь получает access и refresh токены

#### FR-1.2 Авторизация
- Система должна предоставлять вход по email и паролю
- При успешном входе выдаются JWT токены (access и refresh)
- Access токен действителен 7 дней
- Refresh токен действителен 30 дней
- Система должна поддерживать обновление access токена через refresh токен

#### FR-1.3 Роли и права доступа
- Система должна поддерживать три роли:
  - **user**: базовые права (просмотр, заявки, избранное)
  - **shelter_admin**: права пользователя + управление своим приютом и его животными
  - **admin**: полные права на все операции
- Администратор приюта может управлять только своим приютом (проверка по admin_id)
- Администратор приюта не может изменить владельца приюта при обновлении

### 1.2 Управление пользователями

#### FR-2.1 Профиль пользователя
- Пользователь должен иметь возможность просматривать свой профиль
- Пользователь должен иметь возможность редактировать:
  - Имя (максимум 100 символов)
  - Фамилию (максимум 100 символов)
  - Пол (максимум 30 символов)
  - Телефон (максимум 30 символов)
  - Биографию (максимум 2000 символов)
- Email не должен изменяться через API обновления профиля
- Пользователь должен иметь возможность загрузить фото профиля (одно изображение)

#### FR-2.2 Избранные животные
- Пользователь должен иметь возможность добавлять животных в избранное
- Пользователь должен иметь возможность удалять животных из избранного
- Система должна предоставлять массовую проверку статуса избранного для списка животных
- Пользователь должен видеть список избранных животных в своем профиле

### 1.3 Управление приютами

#### FR-3.1 Регистрация приюта
- Администратор приюта должен иметь возможность зарегистрировать один приют
- Обязательные поля при регистрации:
  - Название (минимум 2 символа, максимум 255 символов)
- Опциональные поля:
  - Адрес (максимум 500 символов)
  - Телефон (максимум 50 символов)
  - Email (валидный формат, максимум 255 символов)
  - Веб-сайт (валидный URL, максимум 255 символов)
  - ИНН (10 или 12 цифр)
  - Описание
  - Вместимость (неотрицательное целое число)
  - Режим работы
  - Регион (выбор из списка округов Москвы)
  - Флаг возможности принять животное (can_adopt)
- Администратор приюта может загрузить несколько фотографий приюта

#### FR-3.2 Управление информацией о приюте
- Администратор приюта должен иметь возможность редактировать информацию о своем приюте
- Администратор сайта должен иметь возможность редактировать информацию о любом приюте
- При обновлении приюта нельзя изменить admin_id (владельца)
- Система должна автоматически привязывать приют к администратору при создании

#### FR-3.3 Система рейтингов
- Авторизованные пользователи должны иметь возможность оценить приют (1-5 звезд)
- Система должна автоматически пересчитывать средний рейтинг приюта
- Пользователь может изменить свою оценку (обновление существующего голоса)
- Система должна отслеживать общее количество уникальных голосов (total_ratings)

### 1.4 Управление животными

#### FR-4.1 Создание карточки животного
- Администратор приюта или сайта должен иметь возможность создать карточку животного
- Обязательные поля:
  - Имя (минимум 1 символ, максимум 100 символов)
  - Возраст (целое число от 0 до 30 лет)
  - Тип животного (минимум 1 символ, максимум 50 символов)
  - ID приюта (положительное целое число)
- Опциональные поля:
  - Состояние здоровья (максимум 30 символов)
  - Пол (male/female/unknown)
  - Цвет (максимум 50 символов)
  - Вес
  - Характер (максимум 100 символов)
  - Размер (small/medium/large)
  - История (текст)
- Система должна поддерживать загрузку до 5 фотографий для каждого животного
- Администратор приюта может создавать животных только для своего приюта

#### FR-4.2 Редактирование карточки животного
- Администратор приюта должен иметь возможность редактировать животных своего приюта
- Администратор сайта должен иметь возможность редактировать любых животных
- При обновлении нельзя изменить shelter_id (привязку к приюту)
- Система должна проверять права доступа перед обновлением

#### FR-4.3 Поиск и фильтрация
- Система должна предоставлять поиск животных по:
  - Типу (cat/dog/bird/rodent)
  - Полу (male/female/unknown)
  - Возрасту (диапазон min-max)
  - Размеру (small/medium/large)
  - Состоянию здоровья
  - Приюту (shelter_id)
  - Текстовому поиску (по имени, цвету, типу, характеру, истории)
- Система должна поддерживать комбинирование фильтров
- Система должна поддерживать ограничение количества результатов (limit)

### 1.5 Система заявок

#### FR-5.1 Заявки на усыновление (take)
- Авторизованный пользователь должен иметь возможность подать заявку на усыновление
- Обязательные поля:
  - ID приюта (положительное целое число)
  - ID животного (положительное целое число)
  - Описание (минимум 10 символов, максимум 5000 символов)
- Опциональные поля:
  - Статус (pending/approved/rejected/cancelled, по умолчанию pending)
- user_id берется из токена авторизации
- Администратор приюта должен видеть заявки на животных своего приюта
- Администратор приюта должен иметь возможность изменить статус заявки

#### FR-5.2 Заявки на отдачу (give)
- Авторизованный пользователь должен иметь возможность подать заявку на отдачу животного
- Обязательные поля для животного:
  - Имя (минимум 1 символ)
  - Вид (species)
- Опциональные поля:
  - Порода (breed)
  - Характер (character)
  - Пол (gender)
  - Дата рождения (YYYY-MM-DD)
  - Статус вакцинации
  - Состояние здоровья
  - Особые потребности
  - История
- Пользователь может загрузить фотографию животного
- Система должна создавать запись в таблице animals_to_give
- Администратор приюта должен видеть заявки на отдачу
- Администратор приюта должен иметь возможность изменить статус заявки

### 1.6 Работа с изображениями

#### FR-6.1 Загрузка изображений
- Система должна поддерживать загрузку изображений для:
  - Профиля пользователя (одно изображение)
  - Приютов (несколько изображений)
  - Животных (до 5 изображений)
- Поддерживаемые форматы: JPG, PNG
- Максимальный размер файла: 10 MB
- Система должна автоматически обрезать изображения в квадрат
- Пользователь должен иметь возможность выбрать область обрезки интерактивно

#### FR-6.2 Хранение изображений
- Изображения должны храниться в MinIO (S3-совместимое хранилище)
- Система должна генерировать уникальные имена файлов
- Система должна сохранять метаданные (original_name, size, mimetype)
- Изображения должны быть доступны публично через API

## 2. Нефункциональные требования

### 2.1 Производительность

#### NFR-1.1 Время отклика
- Время отклика API должно быть не более 500ms для 95% запросов
- Время загрузки страницы должно быть не более 3 секунд на стандартном соединении

#### NFR-1.2 Пропускная способность
- Система должна обрабатывать минимум 100 запросов в секунду
- Система должна поддерживать одновременную работу 1000+ пользователей

#### NFR-1.3 Кэширование
- Система должна кэшировать данные приютов и животных в Redis
- Время жизни кэша: 3600 секунд (1 час)
- Кэш должен автоматически инвалидироваться при изменениях данных

### 2.2 Масштабируемость

#### NFR-2.1 Горизонтальное масштабирование
- Backend должен быть готов к горизонтальному масштабированию
- Stateless архитектура (без сохранения состояния на сервере)
- Поддержка нескольких экземпляров приложения

#### NFR-2.2 База данных
- База данных должна поддерживать индексы для частых запросов
- Пул подключений должен быть настроен оптимально

### 2.3 Надежность

#### NFR-3.1 Доступность
- Система должна быть доступна 99% времени (uptime)
- Graceful shutdown при остановке сервера
- Обработка ошибок без падения приложения

#### NFR-3.2 Отказоустойчивость
- Система должна работать при недоступности Redis (fallback в память)
- Система должна работать при недоступности Kafka (логирование без отправки)
- Система должна работать при недоступности MinIO (с предупреждениями)

### 2.4 Безопасность

#### NFR-4.1 Аутентификация
- Пароли должны хешироваться с использованием bcrypt (salt rounds: 10)
- JWT токены должны подписываться секретным ключом
- Токены должны иметь срок действия

#### NFR-4.2 Защита от атак
- Rate limiting: 100 запросов в минуту для общего API
- Rate limiting: 10 запросов в 5 минут для эндпоинтов аутентификации
- Валидация всех входных данных (Joi)
- Защита от SQL-инъекций (параметризованные запросы)
- CORS настройки для ограничения источников запросов

#### NFR-4.3 Безопасность данных
- Пароли не должны возвращаться в ответах API
- Чувствительные данные должны логироваться без паролей
- Ошибки не должны раскрывать внутреннюю структуру системы

### 2.5 Удобство использования

#### NFR-5.1 Интерфейс
- Адаптивный дизайн для мобильных устройств (mobile-first)
- Поддержка основных браузеров (Chrome, Firefox, Safari, Edge)
- Интуитивно понятная навигация

#### NFR-5.2 Обратная связь
- Понятные сообщения об ошибках на русском языке
- Индикаторы загрузки для длительных операций
- Skeleton loading для улучшения восприятия

## 3. Технические требования

### 3.1 Окружение разработки

#### TR-1.1 Требования к серверу
- Node.js версии 20 или выше
- npm версии 10 или выше
- PostgreSQL 12 или выше
- Redis 6 или выше
- MinIO (S3-совместимое хранилище)
- Kafka (опционально, для уведомлений)

#### TR-1.2 Окружение развертывания
- Docker и Docker Compose для контейнеризации
- Поддержка Linux/Unix систем
- Минимум 2GB RAM для сервера
- Минимум 10GB свободного места на диске

### 3.2 API требования

#### TR-2.1 Формат данных
- RESTful API
- JSON для обмена данными
- multipart/form-data для загрузки файлов
- Кодировка UTF-8

#### TR-2.2 HTTP методы
- GET для получения данных
- POST для создания ресурсов
- PUT/PATCH для обновления ресурсов
- DELETE для удаления ресурсов

#### TR-2.3 Коды ответов
- 200 OK — успешный запрос
- 201 Created — ресурс создан
- 400 Bad Request — ошибка валидации
- 401 Unauthorized — требуется авторизация
- 403 Forbidden — недостаточно прав
- 404 Not Found — ресурс не найден
- 409 Conflict — конфликт данных
- 500 Internal Server Error — ошибка сервера

### 3.3 База данных

#### TR-3.1 Структура
- Реляционная база данных PostgreSQL
- Использование миграций для управления схемой
- Индексы на часто используемых полях (id, email, shelter_id, etc.)

#### TR-3.2 Целостность данных
- Foreign key constraints для связей
- Unique constraints для уникальных полей (email)
- NOT NULL constraints для обязательных полей
- Каскадное удаление связанных данных (фото при удалении сущности)

### 3.4 Логирование

#### TR-4.1 Уровни логирования
- ERROR — критические ошибки
- WARN — предупреждения
- INFO — информационные сообщения
- DEBUG — отладочная информация

#### TR-4.2 Формат логов
- Структурированные логи (JSON) в production
- Pretty логи в development
- Request ID для отслеживания запросов
- Ротация логов по датам

## 4. Бизнес-требования

### 4.1 Бизнес-правила

#### BR-1.1 Ограничения
- Администратор приюта может иметь только один приют
- Максимум 5 фотографий на одно животное
- Описание заявки должно быть от 10 до 5000 символов
- Возраст животного не может превышать 30 лет
- Рейтинг приюта: от 1 до 5 звезд

#### BR-1.2 Автоматизация
- Автоматический пересчет рейтинга приюта при голосовании
- Автоматическая привязка приюта к администратору при создании
- Автоматическая инвалидация кэша при изменениях
- Автоматическая отправка email уведомлений (через Kafka)

### 4.2 Соответствие стандартам

#### BR-2.1 Валидация данных
- Email должен соответствовать стандарту RFC 5322
- URL должен быть валидным
- ИНН должен содержать 10 или 12 цифр
- Дата должна быть в формате YYYY-MM-DD

## 5. Требования к интерфейсу

### 5.1 Дизайн

#### UI-1.1 Стилизация
- Использование Tailwind CSS
- Цветовая палитра: зеленые оттенки (green-30, green-40, green-50, etc.)
- Кастомные шрифты: SF Pro Rounded, Inter
- Скругленные углы для элементов (rounded-custom, rounded-custom-small)

#### UI-1.2 Адаптивность
- Поддержка экранов от 320px (мобильные) до 1920px+ (десктоп)
- Breakpoints: sm (640px), md (768px), lg (1024px), xl (1280px), 2xl (1536px)
- Мобильная версия должна быть полнофункциональной

### 5.2 Компоненты

#### UI-2.1 Карточки
- Карточки животных с фото, именем, возрастом, приютом
- Карточки приютов с фото, названием, рейтингом, адресом
- Адаптивные размеры карточек для разных экранов

#### UI-2.2 Формы
- Валидация на клиенте
- Понятные сообщения об ошибках
- Индикаторы обязательных полей
- Поддержка drag-and-drop для загрузки файлов

#### UI-2.3 Модальные окна
- Модальное окно обрезки изображений
- Модальное окно подтверждения действий
- Модальные окна фильтров

## 6. Требования к тестированию

### 6.1 Покрытие тестами

#### TEST-1.1 Unit тесты
- Покрытие сервисов (services)
- Покрытие DAO слоя
- Покрытие валидаторов

#### TEST-1.2 Integration тесты
- Тестирование API endpoints
- Тестирование middleware
- Тестирование роутов

#### TEST-1.3 Требования к покрытию
- Минимум 70% покрытия кода тестами
- Все критические пути должны быть покрыты

### 6.2 Тестовое окружение
- Изолированное тестовое окружение
- Моки для внешних зависимостей (Redis, Kafka, MinIO)
- Автоматический запуск тестов при сборке

## 7. Требования к документации

### 7.1 API документация
- Описание всех endpoints
- Примеры запросов и ответов
- Описание ошибок и кодов ответов

### 7.2 Техническая документация
- Описание архитектуры
- Инструкции по развертыванию
- Руководство по разработке

## 8. Требования к мониторингу

### 8.1 Health checks
- Endpoint `/healthz` для проверки доступности БД
- Endpoint `/ready` для проверки готовности сервера

### 8.2 Метрики
- Логирование времени выполнения запросов
- Отслеживание ошибок с контекстом
- Request ID для трассировки


